<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="favicon.ico">

    <title>salarios</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <!-- Google Font -->
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Ubuntu:700' rel='stylesheet' type='text/css'>
    

    <!-- Table Sorter -->
    <link rel="stylesheet" href="js/themes/blue/style.css" type="text/css" id="" media="print, projection, screen" />
<link href="css/tablas.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
      <script src="js/iframeResizer.contentWindow.min.js"></script>
  </head>


<body>

    <div class="container">
    <div class="row" id="intro">
    
    <div class="col-md-7 nopaddingL">
    <p>ahora madrid: transparencia</p>
        <hr/>
    <p class="bigger">En nuestra voluntad de trasparencia os mostramos el Presupuesto de Ahora 
    Madrid y los ingresos que llevamos hasta el momento.
    </p>
    
    <p>Nuestra intención es publicar al detalle de cada gasto pasada la campaña y una vez contrastadas las facturas que estamos recibiendo. Igual con los 
    ingresos, ya que debemos verificar los datos de las donaciones y 
    micro-créditos.</p>
    
        </div>
    
    <div class="col-md-5 text-right nopaddingR">
    <p>&nbsp;</p>
    <hr/>
    <select>
      <option value="volvo">Gastos Campaña Elecciones Municipales 2015</option>
      <option value="saab">Ingresos Campaña Elecciones Municipales 2015</option>
      <option value="mercedes">Gastos Ejercicio 2015</option>
      <option value="audi">Ingresos Ejercicio 2015</option>
    </select>
    
    <hr/>
    
    <p><em>última actualización: 20 de mayo, 2015</em></p>
    <p><a href="datos_03/gastos.csv"><i class="fa fa-download" style="padding-right: 1em;"></i> <small>descargar .csv</small></a></p>
    </div>
    </div>
    
    <div class="row">
    <div class="col-md-12 noPadding">
    <hr/>
    <h2>Concejales</h2>
    <p>Un concejal tiene un "sueldo legal", pero los concejales de ahoraMadrid se comprometen a limitar su salario neto a aproximadamente 3 salarios mínimos (con algunas variaciones según la situación familiar o necesidades especiales) <br/>La diferencia entre el salario neto real y el salario neto limitado se destina a distintos tipos de donaciones. 
        <br/>  
    </p>
    </div>
    </div>
    
    
     <div class="row">
     <div class="col-md-4 nopaddingL" id="donut"></div>
     <div class="col-md-8 nopaddingR separaTop6">
     
      <div class="row">
      <div class="col-md-2"><h3 id="d1" class="por100">30 %</h3></div>
      <div class="col-md-10"><p class="separaTop">Reducción media de salario. Esta reducción se dedica a donaciones:
      </p></div>
      </div>
      
      <div class="row">
      <div class="col-md-2"><h3 id="d2" class="por100">20 %</h3></div>
      <div class="col-md-10"><p class="separaTop">Financiación de proyectos de innovación social abierta en http://goteo.org
      </p></div>
      </div>
      
      <div class="row">
      <div class="col-md-2"><h3 id="d3" class="por100">80 %</h3></div>
      <div class="col-md-10"><p class="separaTop"> Donación libre <small> (puedes ver los destinatarios en la página de cada concejal) </small>
      </p></div>
      </div>
      
     </div>
     </div>
    
    <div class="row">
    <div class="col-md-12 noPadding">
    <hr/>
    <h4>enero 2015 / noviembre 2015</h4>
    
    <table id="salarios_meses" class="table tablesorter"> 
    <thead> 
    
    <tr> 
        <th>mes</th> 
        <th>salario nominal</th> 
        <th>salario percibido</th> 
        <th>goteo</th>
        <th>donaciones</th>
     </tr> 
     
    </thead> 
    <tbody></tbody> 
    </table> 
    
       <p class="grigio" style="margin-top: 1.5em;"><small>* La legislatura de 2015 comenzó el 15 Junio.</small></p>
    
    </div>
    </div>
    
     <!--<div class="row">
     
     <div class="col-md-12 noPadding" id="totalG">
     	<div class="bg_tot bloque">
     	<p class="concepto">ingresos por salarios</p>
    	<p class="importe money">total</p>
     	</div>
     </div> 
     
     </div>
     
      <div class="row">
     
     <div class="col-md-12 noPadding">
     <div id="partes">
     <div class="bg_t1 bloque">
     <p class="concepto">salarios concejales</p>
     <p class="importe money">total</p>
     </div>
     <div class="bg_t2 bloque">
     <p class="concepto">salarios eventuales</p>
     <p class="importe money">total</p>
     </div>
     <div class="bg_t3 bloque">
     <p class="concepto">goteo</p>
     <p class="importe money">total</p>
     </div>
     <div class="bg_t4 bloque">
     <p class="concepto">donaciones</p>
     <p class="importe money">total</p>
     </div>
     </div> 
     </div>
          
     </div>-->
    
    
    <div class="row">
    
     <div class="col-md-12 noPadding">
     <hr/>
     <h2>en detalle</h2>
    <!-- <h4>concejales</h4>-->
     <p style="margin-bottom: 3em;">En la página de cada concejal puedes conocer los detalles de sus ingresos y los destinatarios de las donaciones.
     </p>
   
     </div>
     
     <div class="col-md-12 noPadding" id="concejales">
     
     
    
     </div>
     
     <div class="col-md-12 noPadding">
      <hr/>
     
      <h4>eventuales</h4>
      <p>Los trabajadores eventuales contratados también tienen una limitación salarial. 
        <br/>
        <a class="btn btn-success" href="eventual.html"> Consultar sección de eventuales</a>
      </p>
      
      
      
    </div>
     
    </div>
    
    <footer>
    <div class="row">
    <div class="col-md-12 noPadding">
    footer
    </div>
    </div>
    
    </footer>
    
    
    </div> <!-- end container -->
    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
     <script src="js/jquery.min.js"></script>
     <!-- Include all compiled plugins (below), or include individual files as needed -->
     <script src="js/bootstrap.min.js"></script>
     
     <!-- CSV parse -->
     <script src="js/papaparse.min.js"></script>
     <!-- formatCurrency -->
     <script src="js/jquery.formatCurrency-1.4.0.pack.js"></script>
      <!-- formatDate -->
      <script src="js/moment-with-locales.js"></script>
     
     <!-- tablesorter -->
     <script type="text/javascript" src="js/jquery.tablesorter.min.js"></script> 
     
     <!-- highcharts.js -->
     <script src="https://code.highcharts.com/highcharts.js"></script>
     <script type="text/javascript" src="https://code.highcharts.com/modules/data.js"></script>
     
     <!-- isotope -->
     <script src="js/isotope.pkgd.js"></script>
     <script src="js/packery-mode.pkgd.min.js"></script>
     
      <!-- cookies -->
     <script src="js/js.cookie.js"></script>
     <script src="js/salarios_common.js"></script>
     
     <script>
      
     var totC = {nominal:0.0, percibido:0.0, goteo:0.0, donacion:0.0, c:0.0, e:0.0};
     moment.locale('es');  // translate dates to es format
     
     var donutData = []; // donut graph data
    
    var infoConcejales;
     
     $(document).ready(function() { 
        $.getJSON( "datos_03/concejal.json", function( data ) {
                infoConcejales=data.concejales  
                parseCSV();     
           
            });


console.log("fin document ready");
    }); //end document ready 
     
  function parseCSV(){
        Papa.parse("datos_03/salarios.csv", {
        download: true,
        header: true,
        delimiter: "\t",    
        complete: function(results) {
            console.log("parsed");
             //console.log(results.data);
            resultados=results
            var meses = []; // todos MM_AAAA
            var mesesR = []; // rótulos MM, AAAA
            var mesesL = []; // labels
            
            var peopleID = []; // just ID // once
            var peopleIDRow = []; // just ID
            var peopleData = []; // data Objects // once
            var peopleDataRow = []; // data Objects
            
            $.each( results.data, function( index, value ) {

                 var obj = value;
                 if( ("fecha" in obj)==false || ("id" in obj) == false || ("nombre" in obj) == false  || ("apellidos" in obj)== false) return true;
                 var miMes = moment(obj.fecha, "DD/MM/YYYY").format("MMMM");
                 var miAnno = moment(obj.fecha, "DD/MM/YYYY").format("YYYY");
                 var mes_anno = miMes +"_" + miAnno;
                 var mesYanno = miMes +", " + miAnno;
                 meses.push(mes_anno);
                 mesesR.push(mesYanno);
                 //console.log(miFecha);
                 peopleIDRow.push(obj.id); 
                 // people data
                 // create new object > add to array
                 peopleDataRow[obj.id] = {nombre: obj.nombre, apellidos: obj.apellidos, status: obj.status, nominal: 0.0, percibido: 0.0, goteo: 0.0, donaciones: 0.0};
            }); 
            
            //console.log(peopleID);
            // unique ID
            
            // var uniqueNames = [];
            $.each(peopleIDRow, function(i, el){
                if($.inArray(el, peopleID) === -1){
                 peopleID.push(el);
                }
            });
            
            for (i = 0; i < peopleID.length; i++) { 
                //console.log(peopleID[i]);
                var ID = peopleID[i];
                var P = peopleDataRow[ID];
                peopleData[ID] = P;
            }
            
            //console.log(peopleData);
                        
            var peopleIDRow = []; // clean up
            var peopleDataRow = [];
                    
            // unique month
            var thisM = meses[0];
            mesesL.push(thisM);
            
            var mesesTot = {};
            //mesesTot[thisM] = 0.0;
            
            mesesTot[thisM] = {nominal: 0.0, percibido: 0.0, goteo: 0.0, donaciones: 0.0};
    
            var mesesRot = []; 
            mesesRot.push(mesesR[0]);
            
            for (i = 0; i < meses.length -1; i++) { 
                var nextM = meses[i+1];
                
                if(thisM == nextM){
                // nothing
                } else {
                    thisM = nextM;
                    mesesL.push(thisM);
                    mesesTot[thisM] = {nominal: 0.0, percibido: 0.0, goteo: 0.0, donaciones: 0.0};
                    mesesRot.push(mesesR[i+1]);
                }
            }
            
            
        $.each( results.data, function( index, value ) {
             var obj = value;
             if( ("fecha" in obj)==false || ("id" in obj) == false || ("nombre" in obj) == false  || ("apellidos" in obj)== false) return true;
             // tot by month
             var miMMMM = moment(obj.fecha, "DD/MM/YYYY").format("MMMM");
             var miAAAA = moment(obj.fecha, "DD/MM/YYYY").format("YYYY");
             var miMM_AAAA = miMMMM + "_" + miAAAA;
             
             // tot by people
             peopleData[obj.id].nominal += parseFloat(obj.s_nominal);
             peopleData[obj.id].percibido += parseFloat(obj.s_percibido);
             peopleData[obj.id].goteo += parseFloat(obj.goteo);
             peopleData[obj.id].donaciones += parseFloat(obj.donacion_1);
             peopleData[obj.id].donaciones += parseFloat(obj.donacion_2);
              
             mesesTot[miMM_AAAA].nominal += parseFloat(obj.s_nominal);
             mesesTot[miMM_AAAA].percibido += parseFloat(obj.s_percibido);
             mesesTot[miMM_AAAA].goteo += parseFloat(obj.goteo);
             mesesTot[miMM_AAAA].donaciones += parseFloat(obj.donacion_1);
             mesesTot[miMM_AAAA].donaciones += parseFloat(obj.donacion_2);
              
             // totals
            // console.log(obj)
             totC['nominal'] += parseFloat(obj.s_nominal);
             totC['percibido'] += parseFloat(obj.s_percibido);
             totC['goteo'] += parseFloat(obj.goteo);
             totC['donacion'] += parseFloat(obj.donacion_1);
             totC['donacion'] += parseFloat(obj.donacion_2);
              
             totC[obj.status] += parseFloat(obj.s_percibido);
                
        }); 
        
        // table > monts
        var myTable =  $("#salarios_meses > tbody");
        for (i = 0; i < mesesL.length; i++) { 
            var thisM = mesesL[i];
            
            var myRow = "<tr>";
            myRow += "<td>" + mesesRot[i] + "</td>" ; // mes, año
            myRow += "<td class='money'>" + mesesTot[thisM].nominal + "</td>" ;
            myRow += "<td class='money'>" + mesesTot[thisM].percibido + "</td>" ;
            myRow += "<td class='money'>" + mesesTot[thisM].goteo + "</td>" ;
            myRow += "<td class='money'>" + mesesTot[thisM].donaciones + "</td>" ;
                        
            $(myTable).append( myRow);
        }
        
        // write total(s)
        $("#totalG .bg_tot p.importe").text(totC['nominal']);
        $("#partes .bg_t1 p.importe").text(totC['c']);
        $("#partes .bg_t2 p.importe").text(totC['e']);
        $("#partes .bg_t3 p.importe").text(totC['goteo']);
        $("#partes .bg_t4 p.importe").text(totC['donacion']);
        
        // calculate width
        var t1W = totC['c'] * 100.00 / totC['nominal'];
        var t2W = totC['e'] * 100.00 / totC['nominal'];
        var t3W = totC['goteo'] * 100.00 / totC['nominal'];
        var t4W = totC['donacion'] * 100.00 / totC['nominal'];
        var t0W = totC['percibido'] * 100.00 / totC['nominal'];
        
        // donut data
        donutData.push(["Salarios neto limitado", 50]);
        donutData.push(["impuestos sobre el salario bruto", 20]);
        donutData.push(["Donaciones", 30 ]);
        
        // update % texts
       // $('#d1').text(t0W.toFixed(1) + '%');
        //$('#d2').text(t3W.toFixed(1) + '%');
        //$('#d3').text(t4W.toFixed(1) + '%');
        
        // assign width
        $('#partes .bg_t1').css({width: t1W.toFixed(4) + '%'});
        $('#partes .bg_t2').css({width: t2W.toFixed(4) + '%'});
        $('#partes .bg_t3').css({width: t3W.toFixed(4) + '%'});
        $('#partes .bg_t4').css({width: t4W.toFixed(4) + '%'});        
        
        // cards concejales / table eventuales
        var myTable =  $("#salarios_eventuales > tbody");             
        generateCards(peopleID, peopleData, infoConcejales);
        window.setTimeout(initC, 500); //ñaaaapa. Si no hay un poco de retraso a veces no ejecuta la funcion de cards
        } // end complete loading json
        
     }); // end pepa parse

}   
     
    var initC=function() {
     console.log("init");
    
    $('.money').formatCurrency({
            decimalSymbol: ',',
            digitGroupSymbol: '.',
            symbol: '€',
            positiveFormat: '%n <span class="euro">%s</span>',
    });
         
    $("#salarios_meses").tablesorter({ 
             // sort on the first column and third column, order asc 
              sortList: [[0,0]] 
         }); 
     
     $("#salarios_eventuales").tablesorter({ 
             // sort on the first column and third column, order asc 
              // sortList: [[0,0]] 
        });     
      
      // isotope
      var $grid = $('#concejales').isotope({
        // options
        itemSelector: '.card',
        // layoutMode: 'fitRows',
        layoutMode: 'packery',
        packery: {
          gutter: 8
        }         
      });
      
      $( ".card" ).click(function() {
        var c = $(this ).data( "id" ); // 52
        Cookies.set('concejal', c, { expires: 7, path: '' });
        window.location.href = "concejal.html";
        // alert( "Handler for " + c);
      }); 
      
      //$(function () {
          $('#donut').highcharts({
              chart: {
                  plotBackgroundColor: null,
                  plotBorderWidth: 0,
                  plotShadow: false
              },
              
              title: {
                  text: ' ',
                  align: 'center',
                  verticalAlign: 'middle'
                  //y: 40
              },
              
              tooltip: {
                  pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
              },
              
              plotOptions: {
                  pie: {
                      dataLabels: {
                          enabled: false,
                          distance: -50,
                          style: {
                              fontWeight: 'bold',
                              color: 'white',
                              textShadow: '0px 1px 2px black'
                          }
                      },
                     // startAngle: -90,
                     // endAngle: 90,
                      center: ['50%', '50%']
                  }
              },
              
              series: [{
                  type: 'pie',
                  name: 'distribución salario bruto',
                  innerSize: '50%',
                  data: donutData
                  }]
          });
      //});      
    }     
     
     
               
    </script>
</body>

</html>
